<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant - Greenomics</title>
    <link rel="icon" href="../../assets/icons/tittle.png">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://www.gstatic.com https://generativelanguage.googleapis.com https://esm.run https://apis.google.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https: blob:; connect-src 'self' https://firestore.googleapis.com https://firebase.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.googleapis.com https://generativelanguage.googleapis.com https://content-firebaseappcheck.googleapis.com https://www.gstatic.com https://apis.google.com https://esm.run https://cdn.jsdelivr.net https://cdnjs.cloudflare.com http://127.0.0.1:* http://localhost:* ws://127.0.0.1:* ws://localhost:*; frame-src 'self' https://accounts.google.com https://*.firebaseapp.com; worker-src 'self' blob:; manifest-src 'self';">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Add jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .nav-button.active { color: #10b981; }
        
        /* Loading animation */
        .dot-flashing { 
            position: relative; 
            width: 5px; 
            height: 5px; 
            border-radius: 5px; 
            background-color: #10b981; 
            animation: dotFlashing 1s infinite linear alternate; 
            animation-delay: .5s; 
            display: inline-block; 
            margin-left: 5px; 
        }
        .dot-flashing::before, .dot-flashing::after { 
            content: ''; 
            display: inline-block; 
            position: absolute; 
            top: 0; 
        }
        .dot-flashing::before { 
            left: -10px; 
            width: 5px; 
            height: 5px; 
            border-radius: 5px; 
            background-color: #10b981; 
            animation: dotFlashing 1s infinite alternate; 
            animation-delay: 0s; 
        }
        .dot-flashing::after { 
            left: 10px; 
            width: 5px; 
            height: 5px; 
            border-radius: 5px; 
            background-color: #10b981; 
            animation: dotFlashing 1s infinite alternate; 
            animation-delay: 1s; 
        }
        @keyframes dotFlashing { 
            0% { background-color: #10b981; } 
            50%, 100% { background-color: #d1fae5; } 
        }
        
        /* Quick notification animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        .quick-notification {
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        
        /* Toast notification animations */
        @keyframes slideIn {
            from { 
                transform: translateX(100%); 
                opacity: 0; 
            }
            to { 
                transform: translateX(0); 
                opacity: 1; 
            }
        }
        
        @keyframes slideOut {
            from { 
                transform: translateX(0); 
                opacity: 1; 
            }
            to { 
                transform: translateX(100%); 
                opacity: 0; 
            }
        }
        
        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        .animate-slide-out {
            animation: slideOut 0.3s ease-in;
        }


        /* Chat section always visible */
        .chat-section { display: flex; }
        
        /* Pastikan chat messages tidak tertutup navbar */
        .chat-section {
            margin-top: 2rem;
            padding-top: 1rem;
        }
        
        #chat-messages {
            padding-top: 3rem !important;
            padding-bottom: 8rem !important;
        }
        
        /* Pastikan input text tidak tertutup bottom navigation */
        .chat-input-container {
            position: fixed;
            bottom: 5rem;
            left: 1rem;
            right: 1rem;
            z-index: 40;
        }

        .chat-bubble {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 16px;
        position: relative;
        word-wrap: break-word;
        margin-bottom: 0.5rem; /* jarak antar bubble */
        }

        .chat-bubble.user {
        background: linear-gradient(to right, #10b981, #059669);
        color: white;
        border-bottom-right-radius: 4px;
        margin-left: auto;
        align-self: flex-end; /* pastikan rata kanan */
        }

        .chat-bubble.ai {
        background: #ffffff;
        color: #1f2937;
        border-bottom-left-radius: 4px;
        margin-right: auto;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .timestamp {
        font-size: 0.7rem;
        color: #9ca3af;
        margin-top: 4px;
        display: block;
        text-align: right;
        }

        .message-content strong { font-weight: 600; }
        .message-content em { font-style: italic; }

        
        /* Progress bar animation */
        .progress-bar-transition {
            transition: width 0.5s ease-in-out;
        }
        
        /* Better scrollbar for chat */
        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .chat-scroll::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-green-50 via-emerald-50 to-teal-100">

    <div id="app-container" class="pb-20">
        <div class="flex flex-col h-screen">
            <div class="bg-gradient-to-r from-green-600 via-emerald-600 to-teal-600 text-white p-6 rounded-b-3xl shadow-xl flex-shrink-0 z-10">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <a href="../../index.html" class="p-2 bg-white/20 rounded-full hover:bg-white/30 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5m7-7l-7 7 7 7"/></svg>
                        </a>
                        <!-- Logo SVG -->
                        <svg width="32" height="32" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" class="flex-shrink-0">
                            <defs>
                                <linearGradient id="gGradientChat" x1="0%" y1="100%" x2="0%" y2="0%">
                                    <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#d1fae5;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <!-- Letter G -->
                            <path d="M 50 15 C 30 15 15 30 15 50 C 15 70 30 85 50 85 C 65 85 77 76 82 63 L 70 58 C 67 66 59 72 50 72 C 37 72 28 62 28 50 C 28 38 37 28 50 28 C 59 28 67 34 70 42 L 82 37 C 77 24 65 15 50 15 M 50 45 L 50 58 L 70 58 L 70 45 Z" fill="url(#gGradientChat)"/>
                            <!-- Leaves -->
                            <ellipse cx="68" cy="18" rx="8" ry="12" fill="#d1fae5" transform="rotate(-25 68 18)"/>
                            <ellipse cx="80" cy="12" rx="10" ry="14" fill="#ffffff" transform="rotate(-15 80 12)"/>
                        </svg>
                        <div class="flex-1">
                            <h1 class="text-xl font-bold">🌱 AI Greenomics Assistant</h1>
                            <p class="text-green-200 text-sm" id="header-status">Konsultan Green Accounting</p>
                        </div>
                    </div>
                    
                </div>
            </div>

            <div class="flex-grow overflow-hidden mt-6">

                <div class="chat-section">
                    <div id="chat-messages" class="flex-grow p-6 pt-8 pb-32 space-y-4 overflow-y-auto chat-scroll">
                        <div class="flex items-start space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-r from-green-400 to-emerald-500 rounded-full flex items-center justify-center text-white text-lg font-bold flex-shrink-0">🌱</div>
                            <div class="bg-white rounded-2xl rounded-tl-none p-4 shadow-lg max-w-md">
                                <div class="text-gray-800 text-sm">
                                    Halo! Saya AI Assistant Greenomics, konsultan ahli Green Accounting untuk UMKM. Saya bisa membantu Anda dengan:
                                    <br><br>
                                    • <strong>Analisis Limbah</strong> - Hitung nilai ekonomi dan potensi profit<br>
                                    • <strong>Saran Produk Daur Ulang</strong> - Ide bisnis circular economy<br>
                                    • <strong>Kalkulasi ROI</strong> - Analisis profit dari pengolahan limbah<br>
                                    • <strong>Strategi Green Accounting</strong> - Tips sustainability UMKM<br>
                                    • <strong>Konsultasi Lingkungan</strong> - Panduan waste management
                                </div>
                            </div>
                        </div>
                        
                        <!-- User Data Summary Card (akan diisi otomatis dari Firestore) -->
                        <div id="user-data-summary" class="hidden mt-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-200">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-semibold text-blue-900 text-sm">📊 Ringkasan Data Aktivitas Anda</h3>
                                <button onclick="toggleDataSummary()" class="text-blue-600 text-xs">Tutup</button>
                            </div>
                            <div id="data-summary-content" class="text-xs text-gray-700 space-y-1">
                                <!-- Content will be loaded from Firestore -->
                            </div>
                        </div>
                        
                        <!-- Quick Action Cards -->
                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <button onclick="sendQuickAction('analisis')" class="bg-green-50 hover:bg-green-100 p-3 rounded-lg text-left transition-colors border-2 border-transparent hover:border-green-200 active:scale-95 transform transition-transform">
                                <div class="text-green-600 font-medium text-sm">📊 Analisis Data Saya</div>
                                <div class="text-xs text-gray-600 mt-1">Analisis aktivitas yang sudah diinput</div>
                            </button>
                            <button onclick="sendQuickAction('produk')" class="bg-blue-50 hover:bg-blue-100 p-3 rounded-lg text-left transition-colors border-2 border-transparent hover:border-blue-200 active:scale-95 transform transition-transform">
                                <div class="text-blue-600 font-medium text-sm">♻️ Saran Produk</div>
                                <div class="text-xs text-gray-600 mt-1">Produk dari limbah saya</div>
                            </button>
                            <button onclick="sendQuickAction('profit')" class="bg-purple-50 hover:bg-purple-100 p-3 rounded-lg text-left transition-colors border-2 border-transparent hover:border-purple-200 active:scale-95 transform transition-transform">
                                <div class="text-purple-600 font-medium text-sm">💰 Hitung Profit</div>
                                <div class="text-xs text-gray-600 mt-1">ROI dari data saya</div>
                            </button>
                            <button onclick="sendQuickAction('ringkasan')" class="bg-orange-50 hover:bg-orange-100 p-3 rounded-lg text-left transition-colors border-2 border-transparent hover:border-orange-200 active:scale-95 transform transition-transform">
                                <div class="text-orange-600 font-medium text-sm">📋 Ringkasan Data</div>
                                <div class="text-xs text-gray-600 mt-1">Lihat semua data input</div>
                            </button>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <div class="mx-auto max-w-5xl xl:max-w-7xl p-2 bg-white rounded-2xl shadow-xl transition-all">
                            <div class="flex items-center space-x-2">
                                <button id="file-upload-button" class="flex-shrink-0 p-3 rounded-full text-gray-500 hover:bg-gray-100 transition-colors" title="Upload File PDF">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19"/></svg>
                                </button>
                                <input type="file" id="file-input" class="hidden" accept=".pdf"/>
                                                  
                                <button 
                                id="refresh-chat-btn" 
                                class="flex-shrink-0 p-3 rounded-full text-gray-500 hover:bg-gray-100 transition-colors" 
                                title="Refresh Chat AI">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 2v6h-6"/>
                                    <path d="M3 12a9 9 0 0 1 15-6.7L21 8"/>
                                    <path d="M3 22v-6h6"/>
                                    <path d="M21 12a9 9 0 0 1-15 6.7L3 16"/>
                                </svg>
                                </button>

                                <textarea 
                                    id="chat-input" 
                                    rows="1" 
                                    placeholder="Tanya AI tentang green accounting..." 
                                    class="w-full p-3 border-none bg-transparent focus:outline-none focus:ring-0 resize-none overflow-y-auto transition-height duration-150"
                                    style="height: 48px;"
                                ></textarea>
                                
                                <button id="send-chat-btn" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-3 rounded-full hover:shadow-lg transition-all flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4 20-7Z"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div> 
        </div> 
    </div> 
    <div id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-sm border-t border-gray-200 p-3 z-40 shadow-lg">
        <div class="flex justify-around items-center max-w-lg mx-auto">
            <a href="../../index.html" class="nav-button flex flex-col items-center space-y-1 text-gray-500 hover:text-green-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg><span class="text-xs font-medium">Dashboard</span></a>
            <a href="chat.html" class="nav-button active flex flex-col items-center space-y-1 text-gray-500 hover:text-green-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423z" /></svg><span class="text-xs font-medium">AI Assistant</span></a>
            <a href="./accounting.html" class="nav-button flex flex-col items-center space-y-1 text-gray-500 hover:text-green-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><span class="text-xs font-medium">Input Data</span></a>
            <a href="./forum.html" class="nav-button flex flex-col items-center space-y-1 text-gray-500 hover:text-green-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg><span class="text-xs font-medium">Reports</span></a>
            <a href="./profil.html" class="nav-button flex flex-col items-center space-y-1 text-gray-500 hover:text-green-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><span class="text-xs font-medium">Profil</span></a>
        </div>
    </div>
    
    <!-- Global functions script - must be loaded before module scripts -->
    <script>
        // Define sendQuickAction function globally FIRST
        window.sendQuickAction = async function(actionType) {
            console.log('🚀 Quick Action:', actionType);
            
            // Emoji untuk setiap action
            const actionEmojis = {
                'analisis': '📊',
                'produk': '♻️',
                'profit': '💰',
                'ringkasan': '📋'
            };
            
            // Definisikan pesan untuk setiap action
            const actionMessages = {
                'analisis': 'Tolong analisis semua data aktivitas lingkungan yang sudah saya input. Berikan insight tentang:\n• Jenis limbah yang paling banyak\n• Eco-score rata-rata saya\n• Area yang perlu ditingkatkan\n• Rekomendasi aksi selanjutnya',
                
                'produk': 'Berdasarkan semua data limbah yang sudah saya input, tolong berikan saran produk yang bisa dibuat:\n• Produk apa yang paling profitable?\n• Bahan baku yang dibutuhkan dari limbah saya\n• Estimasi harga jual\n• Target pasar yang cocok',
                
                'profit': 'Hitung potensi profit dari semua data limbah yang sudah saya input:\n• Total nilai ekonomi yang bisa dihasilkan\n• ROI jika dibuat menjadi produk\n• Perbandingan profit per jenis limbah\n• Rekomendasi fokus bisnis',
                
                'ringkasan': 'Tampilkan ringkasan lengkap dari semua aktivitas lingkungan yang sudah saya input:\n• Total aktivitas per jenis limbah\n• Total berat/volume per material\n• Total nilai ekonomi keseluruhan\n• Timeline aktivitas saya'
            };
            
            // Dapatkan pesan yang sesuai
            const message = actionMessages[actionType];
            
            if (!message) {
                console.error('❌ Unknown action type:', actionType);
                return;
            }
            
            // Tampilkan loading notification kecil
            const emoji = actionEmojis[actionType] || '📤';
            if (window.showQuickNotification) {
                window.showQuickNotification(`${emoji} Mengirim pertanyaan...`, 'info');
            }
            
            // Kirim pesan otomatis
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                // Set message ke input field (agar user bisa lihat)
                chatInput.value = message;
                
                // Auto-resize textarea jika ada banyak baris
                chatInput.style.height = 'auto';
                chatInput.style.height = chatInput.scrollHeight + 'px';
                
                // Trigger send dengan delay kecil untuk smooth UX
                setTimeout(() => {
                    const sendBtn = document.getElementById('send-chat-btn');
                    if (sendBtn) {
                        console.log(`📤 Sending ${actionType} query to AI...`);
                        sendBtn.click();
                        
                        // Clear notification setelah berhasil kirim
                        setTimeout(() => {
                            const notification = document.querySelector('.quick-notification');
                            if (notification) notification.remove();
                        }, 1000);
                    } else {
                        console.error('❌ Send button not found');
                    }
                }, 300);
            } else {
                console.error('❌ Chat input not found');
            }
        };
        
        // Quick notification function (non-intrusive) - Make it global
        window.showQuickNotification = function(message, type = 'info') {
            // Remove existing notification jika ada
            const existing = document.querySelector('.quick-notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.className = 'quick-notification fixed bottom-24 right-4 px-4 py-2 rounded-lg shadow-lg text-white text-sm z-50 animate-fade-in';
            
            // Color based on type
            const colors = {
                'info': 'bg-blue-500',
                'success': 'bg-green-500',
                'error': 'bg-red-500'
            };
            
            notification.classList.add(colors[type] || colors.info);
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Auto-remove setelah 2 detik
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateY(10px)';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 2000);
        };
        
        console.log('✅ Global functions defined');
    </script>
    
    <script type="module">
    import authInstance from '../../assets/js/auth.js';
    import { auth } from '../../config/firebase-init.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { setupChatListeners } from '../../assets/js/chat/chat-logic.js';
    import aiAutoNotificationService from '../../assets/js/core/ai-auto-notification.js';
    
    // Check authentication before loading page
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            console.log('User authenticated:', user.displayName);
            // User is authenticated, continue loading
        } else {
            // Redirect to login if not authenticated
            window.location.href = '../../login.html';
        }
    });
    
    // Quick question function for green accounting
    function askQuickQuestion(question) {
        console.log('🔍 askQuickQuestion called with:', question);
        const chatInput = document.getElementById('chat-input');
        if (chatInput) {
            chatInput.value = question;
            chatInput.focus();
            // Trigger send button click
            const sendBtn = document.getElementById('send-chat-btn');
            if (sendBtn) {
                console.log('🔄 Triggering send button click');
                sendBtn.click();
            } else {
                console.error('❌ Send button not found');
            }
        } else {
            console.error('❌ Chat input not found');
        }
    }
    
    // Make function globally available
    window.askQuickQuestion = askQuickQuestion;
    
    // Functions are now defined in the global script above
    
    // Add message to chat function
    function addMessageToChat(message, sender, isLoading = false) {
        const chatMessages = document.getElementById('chat-messages');
        if (!chatMessages) {
            console.error('❌ Chat messages container not found');
            return null;
        }
        
        const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        
        const messageEl = document.createElement('div');
        messageEl.id = messageId;
        messageEl.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} mb-4`;
        
        const messageContent = document.createElement('div');
        messageContent.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${
            sender === 'user' 
                ? 'bg-green-500 text-white' 
                : 'bg-gray-100 text-gray-800'
        }`;
        
        if (isLoading) {
            messageContent.innerHTML = `
                <div class="flex items-center space-x-2">
                    <div class="dot-flashing"></div>
                    <span>${message}</span>
                </div>
            `;
        } else {
            messageContent.textContent = message;
        }
        
        messageEl.appendChild(messageContent);
        chatMessages.appendChild(messageEl);
        
        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        return messageId;
    }
    
    // Fallback response function for testing
    function getFallbackResponse(message) {
        const responses = [
            "Halo! Saya adalah AI Assistant Green Accounting. Bagaimana saya bisa membantu Anda dengan analisis limbah dan green accounting?",
            "Terima kasih atas pertanyaan Anda. Saya siap membantu menganalisis data limbah dan memberikan saran green accounting untuk UMKM Anda.",
            "Saya dapat membantu Anda dengan:\n- Analisis nilai ekonomi limbah\n- Saran produk daur ulang\n- Kalkulasi profit dari pengolahan limbah\n- Strategi green accounting\n\nApa yang ingin Anda ketahui?",
            "Untuk mendapatkan analisis yang lebih akurat, silakan input data aktivitas lingkungan terlebih dahulu di halaman 'Input Data'.",
            "Saya siap membantu Anda dengan konsultasi green accounting. Silakan ajukan pertanyaan spesifik tentang limbah atau sustainability."
        ];
        
        return responses[Math.floor(Math.random() * responses.length)];
    }
    
    // Send message function
    async function sendMessage() {
        console.log('📤 sendMessage called');
        const input = document.getElementById('chat-input');
        if (!input) {
            console.error('❌ Chat input not found');
            return;
        }
        
        const message = input.value.trim();
        if (!message) {
            console.log('⚠️ No message to send');
            return;
        }
        
        console.log('📤 Sending message:', message);
        
        // Clear input
        input.value = '';
        input.style.height = '48px';
        
        // Add message to chat
        addMessageToChat(message, 'user');
        
        // Show loading
        const loadingId = addMessageToChat('Thinking...', 'assistant', true);
        
        try {
            // Call the chat interaction
            if (window.handleChatInteraction) {
                console.log('🔄 Calling window.handleChatInteraction...');
                const response = await window.handleChatInteraction(message);
                console.log('✅ Response received:', response);
                
                // Remove loading message
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) {
                    loadingEl.remove();
                }
                
                // Add response
                addMessageToChat(response, 'assistant');
            } else {
                console.error('❌ handleChatInteraction not found, trying direct call');
                
                // Try direct call to chat logic
                try {
                    console.log('🔄 Importing chat logic directly...');
                    const { handleChatInteraction } = await import('../../assets/js/chat/chat-logic.js');
                    console.log('✅ Chat logic imported, calling handleChatInteraction...');
                    const response = await handleChatInteraction(message);
                    console.log('✅ Response received via direct import:', response);
                    
                    // Remove loading message
                    const loadingEl = document.getElementById(loadingId);
                    if (loadingEl) {
                        loadingEl.remove();
                    }
                    
                    // Add response
                    addMessageToChat(response, 'assistant');
                } catch (importError) {
                    console.error('❌ Error importing chat logic:', importError);
                    console.log('🔄 Using fallback response');
                    
                    // Use fallback response
                    const response = getFallbackResponse(message);
                    
                    // Remove loading message
                    const loadingEl = document.getElementById(loadingId);
                    if (loadingEl) {
                        loadingEl.remove();
                    }
                    
                    // Add fallback response
                    addMessageToChat(response, 'assistant');
                }
            }
        } catch (error) {
            console.error('❌ Error sending message:', error);
            console.log('🔄 Using fallback response due to error');
            
            // Use fallback response
            const response = getFallbackResponse(message);
            
            // Remove loading message
            const loadingEl = document.getElementById(loadingId);
            if (loadingEl) {
                loadingEl.remove();
            }
            
            // Add fallback response
            addMessageToChat(response, 'assistant');
        }
    }
    
    // Function to load and display user data summary
    async function loadUserDataSummary() {
        try {
            console.log('📊 Loading user data summary...');
            
            // Import getUserDataContext from gemini-service
            const { getUserDataContext } = await import('../../assets/js/core/gemini-service.js');
            const userContext = await getUserDataContext();
            
            if (userContext && userContext.hasData) {
                const summaryCard = document.getElementById('user-data-summary');
                const summaryContent = document.getElementById('data-summary-content');
                
                let html = '<div class="space-y-2">';
                html += `<p><strong class="text-blue-900">Total Aktivitas:</strong> ${userContext.totalActivities}</p>`;
                
                if (userContext.stats) {
                    html += `<p><strong class="text-blue-900">Total Limbah:</strong> ${userContext.stats.totalWaste}</p>`;
                    html += `<p><strong class="text-blue-900">Nilai Ekonomi:</strong> ${userContext.stats.totalEconomicValue}</p>`;
                    html += `<p><strong class="text-blue-900">Rata-rata Eco-Score:</strong> ${userContext.stats.averageEcoScore}/10</p>`;
                }
                
                html += '<p class="text-xs text-gray-600 mt-2 pt-2 border-t border-blue-200">💡 AI sudah memiliki akses ke data aktivitas Anda. Tanya apapun tentang limbah Anda!</p>';
                html += '</div>';
                
                summaryContent.innerHTML = html;
                summaryCard.classList.remove('hidden');
                
                console.log('✅ User data summary loaded');
            } else {
                console.log('ℹ️ No user data available yet');
            }
        } catch (error) {
            console.error('❌ Error loading user data summary:', error);
        }
    }
    
    // Function to toggle data summary visibility
    function toggleDataSummary() {
        const summaryCard = document.getElementById('user-data-summary');
        summaryCard.classList.toggle('hidden');
    }
    
    // Make function globally accessible
    window.toggleDataSummary = toggleDataSummary;
    window.loadUserDataSummary = loadUserDataSummary;
    
    // Function to check and show latest activity notification
    async function checkLatestActivity() {
        try {
            const latestActivityStr = sessionStorage.getItem('latestActivity');
            
            if (latestActivityStr) {
                const activity = JSON.parse(latestActivityStr);
                const activityTime = new Date(activity.timestamp);
                const now = new Date();
                const diffMinutes = (now - activityTime) / (1000 * 60);
                
                // Tampilkan notifikasi jika aktivitas dalam 5 menit terakhir
                if (diffMinutes < 5) {
                    console.log('📢 Latest activity detected:', activity);
                    
                    // Mapping material names ke Indonesia
                    const materialNames = {
                        'plastic': 'plastik',
                        'paper': 'kertas',
                        'metal': 'logam',
                        'organic': 'organik',
                        'electricity': 'listrik',
                        'water': 'air'
                    };
                    
                    const actionNames = {
                        'recycled': 'didaur ulang',
                        'reduced': 'dikurangi',
                        'reused': 'digunakan ulang',
                        'disposed': 'dibuang',
                        'conserved': 'dihemat'
                    };
                    
                    const materialName = materialNames[activity.material] || activity.material;
                    const actionName = actionNames[activity.action] || activity.action;
                    
                    // Buat pesan AI otomatis
                    const aiMessage = `🎉 Saya lihat Anda baru saja menginput data **${materialName}** sebanyak **${activity.amount} ${activity.unit}** yang ${actionName}!

📊 **Detail Aktivitas:**
• Material: ${materialName.charAt(0).toUpperCase() + materialName.slice(1)}
• Jumlah: ${activity.amount} ${activity.unit}
• Aksi: ${actionName.charAt(0).toUpperCase() + actionName.slice(1)}
• Nilai Ekonomi: Rp ${activity.economicValue?.toLocaleString() || 0}
• Eco-Score: ${activity.ecoScore}/10

💡 **Apa yang bisa saya bantu?**
• Ingin analisis lebih detail tentang ${materialName} ini?
• Butuh saran produk yang bisa dibuat?
• Mau hitung potensi profit dari ${materialName} Anda?

Silakan tanya apapun tentang data yang baru saja Anda input! 😊`;

                    // Tampilkan pesan AI
                    setTimeout(() => {
                        addMessageToChat(aiMessage, 'assistant');
                    }, 1000);
                    
                    // Clear session storage setelah ditampilkan
                    sessionStorage.removeItem('latestActivity');
                }
            }
        } catch (error) {
            console.error('Error checking latest activity:', error);
        }
    }

    /**
     * Setup listener untuk AI Auto Notification
     * Mendengarkan event dari sistem auto-notification
     */
    function setupAIAutoNotificationListener() {
        console.log('🔔 Setting up AI auto notification listener...');
        
        // Listen untuk custom event dari auto-notification service
        document.addEventListener('aiAutoNotification', async (event) => {
            console.log('📢 Received AI auto notification event:', event.detail);
            
            const { analysis, activityData, timestamp } = event.detail;
            
            // Tampilkan notifikasi visual di chat
            showAutoNotificationToast(activityData);
            
            // Tambahkan pesan AI ke chat setelah delay singkat
            setTimeout(() => {
                addMessageToChat(analysis, 'assistant');
            }, 2000);
        });
        
        // Check untuk notifikasi yang tersimpan saat page load
        checkStoredAutoNotifications();
    }

    /**
     * Tampilkan toast notification untuk auto-notification
     * @param {Object} activityData - Data aktivitas
     */
    function showAutoNotificationToast(activityData) {
        // Buat toast notification element
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg z-50 max-w-sm animate-slide-in';
        toast.innerHTML = `
            <div class="flex items-center space-x-3">
                <div class="text-2xl">🤖</div>
                <div>
                    <div class="font-semibold">AI Menganalisis Aktivitas Anda!</div>
                    <div class="text-sm opacity-90">Material: ${activityData.material}</div>
                    <div class="text-sm opacity-90">Jumlah: ${activityData.jumlah}</div>
                </div>
            </div>
        `;
        
        // Tambahkan ke body
        document.body.appendChild(toast);
        
        // Auto remove setelah 5 detik
        setTimeout(() => {
            toast.classList.add('animate-slide-out');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 5000);
    }

    /**
     * Check untuk notifikasi auto yang tersimpan di sessionStorage
     */
    function checkStoredAutoNotifications() {
        try {
            const notifications = JSON.parse(sessionStorage.getItem('aiNotifications') || '[]');
            const unreadNotifications = notifications.filter(n => !n.isRead);
            
            if (unreadNotifications.length > 0) {
                console.log(`📬 Found ${unreadNotifications.length} unread AI notifications`);
                
                // Tampilkan notifikasi terbaru
                const latestNotification = unreadNotifications[0];
                
                // Tampilkan toast
                showAutoNotificationToast(latestNotification.activityData);
                
                // Tambahkan ke chat setelah delay
                setTimeout(() => {
                    addMessageToChat(latestNotification.message, 'assistant');
                    
                    // Mark as read
                    if (typeof aiAutoNotificationService !== 'undefined') {
                        aiAutoNotificationService.markNotificationAsRead(latestNotification.id);
                    }
                }, 2000);
            }
        } catch (error) {
            console.error('❌ Error checking stored notifications:', error);
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        console.log('🚀 Initializing chat page...');
        
        // Load user data summary
        loadUserDataSummary();
        
        // Check for latest activity and show notification
        checkLatestActivity();
        
        // Setup AI Auto Notification listener
        setupAIAutoNotificationListener();
        
        // Setup chat listeners
        if (typeof setupChatListeners === 'function') {
            setupChatListeners();
        } else {
            console.log('⚠️ setupChatListeners not available, using manual setup');
        }
        
        // Debug: Check if send button exists and add manual listener
        const sendBtn = document.getElementById('send-chat-btn');
        const chatInput = document.getElementById('chat-input');
        
        console.log('🔍 Send button:', sendBtn);
        console.log('🔍 Chat input:', chatInput);
        
        if (sendBtn) {
            console.log('✅ Send button found, adding manual listener');
            
            // Remove any existing listeners first
            sendBtn.replaceWith(sendBtn.cloneNode(true));
            const newSendBtn = document.getElementById('send-chat-btn');
            
            newSendBtn.addEventListener('click', async (e) => {
                console.log('🔄 Send button clicked!');
                console.log('🔍 Event details:', e);
                e.preventDefault();
                e.stopPropagation();
                
                const input = document.getElementById('chat-input');
                console.log('🔍 Input element:', input);
                console.log('🔍 Input value:', input?.value);
                
                if (input && input.value.trim()) {
                    console.log('📤 Sending message:', input.value);
                    // Call the send function directly
                    try {
                        await sendMessage();
                        console.log('✅ Message sent successfully');
                    } catch (error) {
                        console.error('❌ Error in sendMessage:', error);
                    }
                } else {
                    console.log('⚠️ No message to send');
                    // Show a brief message
                    const originalText = newSendBtn.innerHTML;
                    newSendBtn.innerHTML = '⚠️';
                    setTimeout(() => {
                        newSendBtn.innerHTML = originalText;
                    }, 1000);
                }
            });
            
            console.log('✅ Manual listener added to send button');
        } else {
            console.error('❌ Send button not found!');
        }
        
        // Also add Enter key listener
        if (chatInput) {
            chatInput.addEventListener('keypress', async (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    console.log('⌨️ Enter key pressed');
                    e.preventDefault();
                    if (chatInput.value.trim()) {
                        await sendMessage();
                    }
                }
            });
        }
        
        console.log('✅ Chat page initialized');
    });
    </script>
    <!-- Import chat logic and services -->
    <script type="module" src="../../assets/js/chat/chat-logic.js"></script>
    <script type="module" src="../../assets/js/core/gemini-service.js"></script>
    <script type="module" src="../../assets/js/core/local-storage-service.js"></script>
    <script type="module" src="../../assets/js/core/testing-account-service.js"></script>
    <!-- Di index.html dan profil.html -->
    <script type="module" src="../../assets/js/auth.js"></script>
    <script type="module" src="../../assets/js/core/user-stats.js"></script>
</body>
</html>