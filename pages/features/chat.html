<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant - Greenomics</title>
    <link rel="icon" href="../../assets/icons/logo.png">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://www.gstatic.com https://generativelanguage.googleapis.com https://esm.run https://apis.google.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https: blob:; connect-src 'self' https://firestore.googleapis.com https://firebase.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.googleapis.com https://generativelanguage.googleapis.com https://content-firebaseappcheck.googleapis.com https://www.gstatic.com https://apis.google.com https://esm.run https://cdn.jsdelivr.net https://cdnjs.cloudflare.com http://127.0.0.1:* http://localhost:* ws://127.0.0.1:* ws://localhost:*; frame-src 'self' https://accounts.google.com https://*.firebaseapp.com; worker-src 'self' blob:; manifest-src 'self';">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Add jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .nav-button.active { color: #10b981; }
        
        /* Loading animation */
        .dot-flashing { 
            position: relative; 
            width: 5px; 
            height: 5px; 
            border-radius: 5px; 
            background-color: #10b981; 
            animation: dotFlashing 1s infinite linear alternate; 
            animation-delay: .5s; 
            display: inline-block; 
            margin-left: 5px; 
        }
        .dot-flashing::before, .dot-flashing::after { 
            content: ''; 
            display: inline-block; 
            position: absolute; 
            top: 0; 
        }
        .dot-flashing::before { 
            left: -10px; 
            width: 5px; 
            height: 5px; 
            border-radius: 5px; 
            background-color: #10b981; 
            animation: dotFlashing 1s infinite alternate; 
            animation-delay: 0s; 
        }
        .dot-flashing::after { 
            left: 10px; 
            width: 5px; 
            height: 5px; 
            border-radius: 5px; 
            background-color: #10b981; 
            animation: dotFlashing 1s infinite alternate; 
            animation-delay: 1s; 
        }
        @keyframes dotFlashing { 
            0% { background-color: #10b981; } 
            50%, 100% { background-color: #d1fae5; } 
        }
        
        /* Quick notification animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        .quick-notification {
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        
        /* Toast notification animations */
        @keyframes slideIn {
            from { 
                transform: translateX(100%); 
                opacity: 0; 
            }
            to { 
                transform: translateX(0); 
                opacity: 1; 
            }
        }
        
        @keyframes slideOut {
            from { 
                transform: translateX(0); 
                opacity: 1; 
            }
            to { 
                transform: translateX(100%); 
                opacity: 0; 
            }
        }
        
        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        .animate-slide-out {
            animation: slideOut 0.3s ease-in;
        }


        /* Chat section always visible */
        .chat-section { display: flex; }
        
        /* Pastikan chat messages tidak tertutup navbar */
        .chat-section {
            margin-top: 2rem;
            padding-top: 1rem;
        }
        
        #chat-messages {
            padding-top: 1rem !important;
            padding-bottom: 8rem !important;
            min-height: calc(100vh - 200px);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        
        /* Pastikan input text tidak tertutup bottom navigation */
        .chat-input-container {
            position: fixed;
            bottom: 5rem;
            left: 1rem;
            right: 1rem;
            z-index: 40;
        }

        /* Chat bubble styles - unified */
        .chat-bubble, .message-bubble {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 16px;
        position: relative;
        word-wrap: break-word;
        margin-bottom: 0.5rem; /* jarak antar bubble */
        }

        .chat-bubble.user, .message-bubble.user {
        background: linear-gradient(to right, #10b981, #059669);
        color: white;
        border-bottom-right-radius: 4px;
        margin-left: auto;
        align-self: flex-end; /* pastikan rata kanan */
        }

        .chat-bubble.ai, .message-bubble.ai {
        background: #ffffff;
        color: #1f2937;
        border-bottom-left-radius: 4px;
        margin-right: auto;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .timestamp {
        font-size: 0.7rem;
        color: #9ca3af;
        margin-top: 4px;
        display: block;
        text-align: right;
        }

        .message-content strong { font-weight: 600; }
        .message-content em { font-style: italic; }

        
        /* Progress bar animation */
        .progress-bar-transition {
            transition: width 0.5s ease-in-out;
        }
        
        /* Better scrollbar for chat */
        .chat-scroll::-webkit-scrollbar { width: 8px; }
        .chat-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #10b981; border-radius: 4px; }
        .chat-scroll::-webkit-scrollbar-thumb:hover { background: #059669; }
        
        /* Firefox scrollbar */
        .chat-scroll {
            scrollbar-width: thin;
            scrollbar-color: #10b981 #f1f1f1;
        }
        
        /* Scrollable message content */
        .message-content {
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 #f1f1f1;
            scroll-behavior: smooth;
            transition: all 0.3s ease;
        }
        
        .message-content::-webkit-scrollbar { width: 4px; }
        .message-content::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 2px; }
        .message-content::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 2px; }
        .message-content::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        /* Smooth message bubble animations */
        .message-bubble {
            animation: slideInUp 0.4s ease-out;
            transform-origin: bottom;
            transition: all 0.3s ease;
        }
        
        .message-bubble.user {
            animation: slideInRight 0.4s ease-out;
        }
        
        .message-bubble.ai {
            animation: slideInLeft 0.4s ease-out;
        }
        
        .message-bubble:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .message-bubble.user:hover {
            transform: translateY(-2px) translateX(5px);
        }
        
        .message-bubble.ai:hover {
            transform: translateY(-2px) translateX(-5px);
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        
        /* Smooth scrolling for chat container */
        .chat-scroll {
            scroll-behavior: smooth;
        }
        
        /* Loading animation improvements */
        .dot-flashing {
            animation: dotFlashing 1.2s infinite linear alternate;
        }
        
        @keyframes dotFlashing {
            0% { 
                background-color: #10b981; 
                transform: scale(1);
            }
            50%, 100% { 
                background-color: #d1fae5; 
                transform: scale(1.1);
            }
        }
        
        /* Typing animation for AI responses */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #10b981;
            animation: typingPulse 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes typingPulse {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* Smooth content reveal animation */
        .content-reveal {
            animation: contentReveal 0.6s ease-out;
        }
        
        @keyframes contentReveal {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-green-50 via-emerald-50 to-teal-100">

    <div id="app-container" class="pb-20">
        <div class="flex flex-col h-screen">
            <div class="bg-gradient-to-r from-green-600 via-emerald-600 to-teal-600 text-white p-6 rounded-b-3xl shadow-xl flex-shrink-0 z-10">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <a href="../../index.html" class="p-2 bg-white/20 rounded-full hover:bg-white/30 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5m7-7l-7 7 7 7"/></svg>
                        </a>
                        <div class="flex-1">
                            <h1 class="text-xl font-bold flex items-center">
                                <img src="../../assets/icons/logo.png" alt="Greenomics" class="w-5 h-5 mr-2">
                                AI Greenomics Assistant
                            </h1>
                            <p class="text-green-200 text-sm" id="header-status">Konsultan Green Accounting</p>
                        </div>
                    </div>
                    
                </div>
            </div>

            <div class="flex-grow overflow-hidden mt-6">

                <div class="chat-section">
                    <div id="chat-messages" class="flex-grow p-6 pt-8 pb-32 space-y-4 overflow-y-auto chat-scroll">
                        <div class="flex items-start space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-r from-green-400 to-emerald-500 rounded-full flex items-center justify-center text-white text-lg font-bold flex-shrink-0">
                                <img src="../../assets/icons/logo.png" alt="AI" class="w-6 h-6">
                            </div>
                            <div class="bg-white rounded-2xl rounded-tl-none p-4 shadow-lg max-w-md">
                                <div class="text-gray-800 text-sm">
                                    Halo! Saya AI Assistant Greenomics, konsultan ahli Green Accounting untuk UMKM. Saya bisa membantu Anda dengan:
                                    <br><br>
                                    ‚Ä¢ <strong>Analisis Limbah</strong> - Hitung nilai ekonomi dan potensi profit<br>
                                    ‚Ä¢ <strong>Saran Produk Daur Ulang</strong> - Ide bisnis circular economy<br>
                                    ‚Ä¢ <strong>Kalkulasi ROI</strong> - Analisis profit dari pengolahan limbah<br>
                                    ‚Ä¢ <strong>Strategi Green Accounting</strong> - Tips sustainability UMKM<br>
                                    ‚Ä¢ <strong>Konsultasi Lingkungan</strong> - Panduan waste management
                                </div>
                            </div>
                        </div>
                        
                        <!-- User Data Summary Card (akan diisi otomatis dari Firestore) -->
                        <div id="user-data-summary" class="hidden mt-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-200">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-semibold text-blue-900 text-sm">üìä Ringkasan Data Aktivitas Anda</h3>
                                <button onclick="toggleDataSummary()" class="text-blue-600 text-xs">Tutup</button>
                            </div>
                            <div id="data-summary-content" class="text-xs text-gray-700 space-y-1">
                                <!-- Content will be loaded from Firestore -->
                            </div>
                        </div>
                        
                        <!-- Quick Action Cards -->
                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <button onclick="sendQuickAction('analisis')" class="bg-green-50 hover:bg-green-100 p-3 rounded-lg text-left transition-colors border-2 border-transparent hover:border-green-200 active:scale-95 transform transition-transform">
                                <div class="text-green-600 font-medium text-sm">üìä Analisis Data Saya</div>
                                <div class="text-xs text-gray-600 mt-1">Analisis aktivitas yang sudah diinput</div>
                            </button>
                            <button onclick="sendQuickAction('produk')" class="bg-blue-50 hover:bg-blue-100 p-3 rounded-lg text-left transition-colors border-2 border-transparent hover:border-blue-200 active:scale-95 transform transition-transform">
                                <div class="text-blue-600 font-medium text-sm">‚ôªÔ∏è Saran Produk</div>
                                <div class="text-xs text-gray-600 mt-1">Produk dari limbah saya</div>
                            </button>
                            <button onclick="sendQuickAction('profit')" class="bg-purple-50 hover:bg-purple-100 p-3 rounded-lg text-left transition-colors border-2 border-transparent hover:border-purple-200 active:scale-95 transform transition-transform">
                                <div class="text-purple-600 font-medium text-sm">üí∞ Hitung Profit</div>
                                <div class="text-xs text-gray-600 mt-1">ROI dari data saya</div>
                            </button>
                            <button onclick="sendQuickAction('ringkasan')" class="bg-orange-50 hover:bg-orange-100 p-3 rounded-lg text-left transition-colors border-2 border-transparent hover:border-orange-200 active:scale-95 transform transition-transform">
                                <div class="text-orange-600 font-medium text-sm">üìã Ringkasan Data</div>
                                <div class="text-xs text-gray-600 mt-1">Lihat semua data input</div>
                            </button>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <div class="mx-auto max-w-5xl xl:max-w-7xl p-2 bg-white rounded-2xl shadow-xl transition-all">
                            <div class="flex items-center space-x-2">
                                <button id="file-upload-button" class="flex-shrink-0 p-3 rounded-full text-gray-500 hover:bg-gray-100 transition-colors" title="Upload File PDF">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19"/></svg>
                                </button>
                                <input type="file" id="file-input" class="hidden" accept=".pdf"/>
                                                  
                                <button 
                                id="refresh-chat-btn" 
                                class="flex-shrink-0 p-3 rounded-full text-gray-500 hover:bg-gray-100 transition-colors" 
                                title="Refresh Chat AI">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 2v6h-6"/>
                                    <path d="M3 12a9 9 0 0 1 15-6.7L21 8"/>
                                    <path d="M3 22v-6h6"/>
                                    <path d="M21 12a9 9 0 0 1-15 6.7L3 16"/>
                                </svg>
                                </button>

                                <textarea 
                                    id="chat-input" 
                                    rows="1" 
                                    placeholder="Tanya AI tentang green accounting..." 
                                    class="w-full p-3 border-none bg-transparent focus:outline-none focus:ring-0 resize-none overflow-y-auto transition-height duration-150"
                                    style="height: 48px;"
                                ></textarea>
                                
                                <button id="send-chat-btn" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-3 rounded-full hover:shadow-lg transition-all flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4 20-7Z"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div> 
        </div> 
    </div> 
    <div id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-sm border-t border-gray-200 p-3 z-40 shadow-lg">
        <div class="flex justify-around items-center max-w-lg mx-auto">
            <a href="../../index.html" class="nav-button flex flex-col items-center space-y-1 text-gray-500 hover:text-green-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg><span class="text-xs font-medium">Dashboard</span></a>
            <a href="chat.html" class="nav-button active flex flex-col items-center space-y-1 text-gray-500 hover:text-green-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423z" /></svg><span class="text-xs font-medium">AI Assistant</span></a>
            <a href="./accounting.html" class="nav-button flex flex-col items-center space-y-1 text-gray-500 hover:text-green-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><span class="text-xs font-medium">Input Data</span></a>
            <a href="./forum.html" class="nav-button flex flex-col items-center space-y-1 text-gray-500 hover:text-green-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg><span class="text-xs font-medium">Reports</span></a>
            <a href="./profil.html" class="nav-button flex flex-col items-center space-y-1 text-gray-500 hover:text-green-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><span class="text-xs font-medium">Profil</span></a>
        </div>
    </div>
    
    <!-- Global functions script - must be loaded before module scripts -->
    <script>
        // Define sendQuickAction function globally FIRST
        window.sendQuickAction = async function(actionType) {
            console.log('üöÄ Quick Action:', actionType);
            
            // Emoji untuk setiap action
            const actionEmojis = {
                'analisis': 'üìä',
                'produk': '‚ôªÔ∏è',
                'profit': 'üí∞',
                'ringkasan': 'üìã'
            };
            
            // Definisikan pesan untuk setiap action
            const actionMessages = {
                'analisis': 'Tolong analisis semua data aktivitas lingkungan yang sudah saya input. Berikan insight tentang:\n‚Ä¢ Jenis limbah yang paling banyak\n‚Ä¢ Eco-score rata-rata saya\n‚Ä¢ Area yang perlu ditingkatkan\n‚Ä¢ Rekomendasi aksi selanjutnya',
                
                'produk': 'Berdasarkan semua data limbah yang sudah saya input, tolong berikan saran produk yang bisa dibuat:\n‚Ä¢ Produk apa yang paling profitable?\n‚Ä¢ Bahan baku yang dibutuhkan dari limbah saya\n‚Ä¢ Estimasi harga jual\n‚Ä¢ Target pasar yang cocok',
                
                'profit': 'Hitung potensi profit dari semua data limbah yang sudah saya input:\n‚Ä¢ Total nilai ekonomi yang bisa dihasilkan\n‚Ä¢ ROI jika dibuat menjadi produk\n‚Ä¢ Perbandingan profit per jenis limbah\n‚Ä¢ Rekomendasi fokus bisnis',
                
                'ringkasan': 'Tampilkan ringkasan lengkap dari semua aktivitas lingkungan yang sudah saya input:\n‚Ä¢ Total aktivitas per jenis limbah\n‚Ä¢ Total berat/volume per material\n‚Ä¢ Total nilai ekonomi keseluruhan\n‚Ä¢ Timeline aktivitas saya'
            };
            
            // Dapatkan pesan yang sesuai
            const message = actionMessages[actionType];
            
            if (!message) {
                console.error('‚ùå Unknown action type:', actionType);
                return;
            }
            
            // Tampilkan loading notification kecil
            const emoji = actionEmojis[actionType] || 'üì§';
            if (window.showQuickNotification) {
                window.showQuickNotification(`${emoji} Mengirim pertanyaan...`, 'info');
            }
            
            // Kirim pesan otomatis
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                // Set message ke input field (agar user bisa lihat)
                chatInput.value = message;
                
                // Auto-resize textarea jika ada banyak baris
                chatInput.style.height = 'auto';
                chatInput.style.height = chatInput.scrollHeight + 'px';
                
                // Trigger send dengan delay kecil untuk smooth UX
                setTimeout(() => {
                    const sendBtn = document.getElementById('send-chat-btn');
                    if (sendBtn) {
                        console.log(`üì§ Sending ${actionType} query to AI...`);
                        sendBtn.click();
                        
                        // Clear notification setelah berhasil kirim
                        setTimeout(() => {
                            const notification = document.querySelector('.quick-notification');
                            if (notification) notification.remove();
                        }, 1000);
                    } else {
                        console.error('‚ùå Send button not found');
                    }
                }, 300);
            } else {
                console.error('‚ùå Chat input not found');
            }
        };
        
        // Quick notification function (non-intrusive) - Make it global
        window.showQuickNotification = function(message, type = 'info') {
            // Remove existing notification jika ada
            const existing = document.querySelector('.quick-notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.className = 'quick-notification fixed bottom-24 right-4 px-4 py-2 rounded-lg shadow-lg text-white text-sm z-50 animate-fade-in';
            
            // Color based on type
            const colors = {
                'info': 'bg-blue-500',
                'success': 'bg-green-500',
                'error': 'bg-red-500'
            };
            
            notification.classList.add(colors[type] || colors.info);
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Auto-remove setelah 2 detik
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateY(10px)';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 2000);
        };
        
        console.log('‚úÖ Global functions defined');
    </script>
    
    <script type="module">
    import authInstance from '../../assets/js/auth.js';
    import { auth } from '../../config/firebase-init.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { setupChatListeners } from '../../assets/js/chat/chat-logic.js';
    import aiAutoNotificationService from '../../assets/js/core/ai-auto-notification.js';
    
    // Check authentication before loading page
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            console.log('User authenticated:', user.displayName);
            // User is authenticated, now load data summary
            try {
                await loadUserDataSummary();
            } catch (error) {
                console.error('Error loading user data summary after authentication:', error);
            }
        } else {
            // Redirect to login if not authenticated
            window.location.href = '../../login.html';
        }
    });
    
    // Quick question function for green accounting
    function askQuickQuestion(question) {
        console.log('üîç askQuickQuestion called with:', question);
        const chatInput = document.getElementById('chat-input');
        if (chatInput) {
            chatInput.value = question;
            chatInput.focus();
            // Trigger send button click
            const sendBtn = document.getElementById('send-chat-btn');
            if (sendBtn) {
                console.log('üîÑ Triggering send button click');
                sendBtn.click();
            } else {
                console.error('‚ùå Send button not found');
            }
        } else {
            console.error('‚ùå Chat input not found');
        }
    }
    
    // Make function globally available
    window.askQuickQuestion = askQuickQuestion;
    
    // Functions are now defined in the global script above
    
    // Add message to chat function - improved formatting
    function addMessageToChat(message, sender, isLoading = false) {
        console.log('üìù Adding message to chat:', { message, sender, isLoading });
        
        const chatMessages = document.getElementById('chat-messages');
        if (!chatMessages) {
            console.error('‚ùå Chat messages container not found');
            return null;
        }
        
        const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        let messageHTML = '';
        
        if (sender === 'user') {
            messageHTML = `
                <div class="flex items-end justify-end mb-4 space-x-2 message-bubble user">
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-2xl rounded-br-none p-4 shadow-lg max-w-2xl">
                        <p class="text-sm whitespace-pre-wrap">${escapeHtml(message)}</p>
                        <span class="timestamp">${timestamp}</span>
                    </div>
                    <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5.121 17.804A9.969 9.969 0 0112 15c2.21 0 4.232.72 5.879 1.926M15 12a3 3 0 10-6 0 3 3 0 006 0z"/>
                        </svg>
                    </div>
                </div>
            `;
        } else {
            messageHTML = `
                <div id="${messageId}" class="flex items-start mb-4 space-x-2 message-bubble ai">
                    <div class="w-10 h-10 bg-gradient-to-r from-green-400 to-emerald-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <img src="../../assets/icons/logo.png" alt="AI" class="w-6 h-6">
                    </div>
                    <div class="bg-white rounded-2xl rounded-tl-none p-4 shadow-lg max-w-2xl">
                        <div class="text-gray-800 text-sm message-content max-h-96 overflow-y-auto">
                            ${isLoading ? '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>' : formatAIMessage(message)}
                        </div>
                        <span class="timestamp">${timestamp}</span>
                    </div>
                </div>
            `;
        }
        
        // Insert message HTML
        chatMessages.insertAdjacentHTML('beforeend', messageHTML);
        console.log('‚úÖ Message HTML inserted');
        
        // Force scroll to bottom after a short delay
        setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
            console.log('üìú Scrolled to bottom, scrollHeight:', chatMessages.scrollHeight);
        }, 50);
        
        // Additional scroll fix for better compatibility
        setTimeout(() => {
            chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: 'smooth'
            });
        }, 100);
        
        return messageId;
    }
    
    // Format AI message with enhanced markdown support
    function formatAIMessage(msg) {
        return msg
            .replace(/\*\*(.*?)\*\*/g, '<strong class="text-gray-900 font-semibold">$1</strong>')
            .replace(/\*(.*?)\*/g, '<em class="text-gray-700 italic">$1</em>')
            .replace(/## (.*?)(?=\n|$)/g, '<h3 class="text-lg font-bold text-gray-800 mt-4 mb-2 border-b border-gray-200 pb-1">$1</h3>')
            .replace(/### (.*?)(?=\n|$)/g, '<h4 class="text-md font-semibold text-gray-800 mt-3 mb-2">$1</h4>')
            .replace(/‚Ä¢ (.*?)(?=\n|$)/g, '<div class="flex items-start mb-1"><span class="text-green-500 mr-2">‚Ä¢</span><span>$1</span></div>')
            .replace(/\n\n/g, '<div class="my-3"></div>')
            .replace(/\n/g, '<br>');
    }
    
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Update message function - compatible with chat-logic.js
    function updateMessage(messageId, newText) {
        const messageElement = document.getElementById(messageId);
        if (!messageElement) return;
        const textElement = messageElement.querySelector('.message-content');
        if (textElement) {
            // Add smooth transition for content update
            textElement.style.opacity = '0.7';
            textElement.style.transform = 'scale(0.98)';
            
            setTimeout(() => {
                textElement.innerHTML = formatAIMessage(newText);
                textElement.classList.add('content-reveal');
                textElement.style.opacity = '1';
                textElement.style.transform = 'scale(1)';
                
                // Smooth scroll to bottom after update
                const chatContainer = document.getElementById('chat-messages');
                if (chatContainer) {
                    chatContainer.scrollTo({
                        top: chatContainer.scrollHeight,
                        behavior: 'smooth'
                    });
                }
            }, 150);
        }
    }
    
    // Enhanced fallback response function
    function getFallbackResponse(message) {
        const lowerMessage = message.toLowerCase();
        
        // Check for specific keywords and provide targeted responses
        if (lowerMessage.includes('analisis') || lowerMessage.includes('analisis limbah')) {
            return `## üìä **Analisis Limbah**

Saya siap membantu menganalisis data limbah Anda! Untuk analisis yang akurat:

**üìã Data yang Dibutuhkan:**
‚Ä¢ Jenis limbah (plastik, kertas, organik, dll.)
‚Ä¢ Jumlah/volume limbah
‚Ä¢ Frekuensi produksi
‚Ä¢ Lokasi pengolahan

**üí° Yang Bisa Saya Analisis:**
‚Ä¢ **Nilai Ekonomi** - Potensi profit dari limbah
‚Ä¢ **Eco-Score** - Dampak lingkungan
‚Ä¢ **Saran Produk** - Ide bisnis circular economy
‚Ä¢ **ROI Calculation** - Return on investment

Silakan input data aktivitas di halaman "Input Data" untuk analisis yang lebih detail!`;
        }
        
        if (lowerMessage.includes('produk') || lowerMessage.includes('daur ulang')) {
            return `## ‚ôªÔ∏è **Saran Produk Daur Ulang**

Berdasarkan jenis limbah yang Anda miliki, saya bisa memberikan saran produk yang profitable:

**üîÑ Produk Populer:**
‚Ä¢ **Plastik** ‚Üí Pot, tas, furniture
‚Ä¢ **Kertas** ‚Üí Kertas daur ulang, kerajinan
‚Ä¢ **Organik** ‚Üí Kompos, biogas, pupuk
‚Ä¢ **Logam** ‚Üí Kerajinan, furniture

**üí∞ Potensi Profit:**
‚Ä¢ Margin: 30-70%
‚Ä¢ Payback: 3-6 bulan
‚Ä¢ Market: Lokal & ekspor

Input data limbah Anda untuk saran yang lebih spesifik!`;
        }
        
        if (lowerMessage.includes('profit') || lowerMessage.includes('roi')) {
            return `## üí∞ **Analisis Profit & ROI**

Saya bisa menghitung potensi profit dari pengolahan limbah Anda:

**üìà Kalkulasi yang Tersedia:**
‚Ä¢ **ROI** - Return on Investment
‚Ä¢ **Payback Period** - Waktu balik modal
‚Ä¢ **Annual Profit** - Profit tahunan
‚Ä¢ **Break-even Point** - Titik impas

**üéØ Faktor yang Mempengaruhi:**
‚Ä¢ Jenis & kualitas limbah
‚Ä¢ Biaya produksi
‚Ä¢ Harga pasar
‚Ä¢ Volume produksi

Input data aktivitas untuk kalkulasi yang akurat!`;
        }
        
        // Default responses
        const responses = [
            `## ü§ñ **AI Assistant Greenomics**

Halo! Saya AI Assistant Green Accounting untuk UMKM. Saya bisa membantu Anda dengan:

**üìä Analisis Limbah:**
‚Ä¢ Hitung nilai ekonomi limbah
‚Ä¢ Analisis eco-score
‚Ä¢ Saran produk daur ulang

**üí° Konsultasi Bisnis:**
‚Ä¢ Strategi circular economy
‚Ä¢ Kalkulasi ROI
‚Ä¢ Tips green accounting

**üöÄ Quick Actions:**
‚Ä¢ Klik tombol di atas untuk analisis cepat
‚Ä¢ Input data di halaman "Input Data"
‚Ä¢ Tanya apapun tentang limbah Anda!

Apa yang ingin Anda ketahui?`,

            `## üå± **Green Accounting Consultant**

Terima kasih atas pertanyaan Anda! Saya siap membantu dengan:

**üîç Analisis Data:**
‚Ä¢ Evaluasi aktivitas lingkungan
‚Ä¢ Perhitungan nilai ekonomi
‚Ä¢ Assessment dampak lingkungan

**üíº Strategi Bisnis:**
‚Ä¢ Circular economy implementation
‚Ä¢ Waste-to-profit strategies
‚Ä¢ Sustainability reporting

**üìã Next Steps:**
1. Input data aktivitas di "Input Data"
2. Klik quick action buttons
3. Tanya spesifik tentang limbah Anda

Mari mulai analisis green accounting Anda!`
        ];
        
        return responses[Math.floor(Math.random() * responses.length)];
    }
    
    // Send message function - enhanced to properly display AI responses
    async function sendMessage() {
        console.log('üì§ sendMessage called');
        const input = document.getElementById('chat-input');
        if (!input) {
            console.error('‚ùå Chat input not found');
            return;
        }
        
        const message = input.value.trim();
        if (!message) {
            console.log('‚ö†Ô∏è No message to send');
            return;
        }
        
        console.log('üì§ Sending message:', message);
        
        // Clear input immediately
        input.value = '';
        input.style.height = '48px';
        
        // Add user message to chat FIRST
        console.log('üë§ Adding user message to chat...');
        const userMessageId = addMessageToChat(message, 'user');
        console.log('‚úÖ User message added with ID:', userMessageId);
        
        // Show loading message
        console.log('ü§ñ Adding loading message...');
        const loadingId = addMessageToChat('ü§ñ AI sedang berpikir...', 'assistant', true);
        console.log('‚úÖ Loading message added with ID:', loadingId);
        
        try {
            // Use the handleChatInteraction from chat-logic.js
            if (window.handleChatInteraction) {
                console.log('üîÑ Calling window.handleChatInteraction...');
                
                // Remove loading message first
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) {
                    loadingEl.remove();
                    console.log('üóëÔ∏è Loading message removed');
                }
                
                // Call handleChatInteraction (it will add its own loading and response)
                await window.handleChatInteraction(message);
                console.log('‚úÖ Message processed by chat-logic.js');
            } else {
                console.error('‚ùå handleChatInteraction not found, using fallback');
                
                // Remove loading message
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) {
                    loadingEl.remove();
                    console.log('üóëÔ∏è Loading message removed');
                }
                
                // Fallback: add response manually
                console.log('üîÑ Adding fallback response...');
                const response = getFallbackResponse(message);
                addMessageToChat(response, 'assistant');
                console.log('‚úÖ Fallback response added');
            }
        } catch (error) {
            console.error('‚ùå Error sending message:', error);
            
            // Remove loading message
            const loadingEl = document.getElementById(loadingId);
            if (loadingEl) {
                loadingEl.remove();
                console.log('üóëÔ∏è Loading message removed due to error');
            }
            
            // Show error message
            addMessageToChat('Maaf, terjadi kesalahan saat memproses pesan Anda. Silakan coba lagi.', 'assistant');
        }
    }
    
    // Function to load and display user data summary
    async function loadUserDataSummary() {
        try {
            console.log('üìä Loading user data summary...');
            
            // Import getUserDataContext from gemini-service
            const { getUserDataContext } = await import('../../assets/js/core/gemini-service.js');
            const userContext = await getUserDataContext();
            
            if (userContext && userContext.hasData) {
                const summaryCard = document.getElementById('user-data-summary');
                const summaryContent = document.getElementById('data-summary-content');
                
                if (!summaryCard || !summaryContent) {
                    console.log('‚ÑπÔ∏è Summary card elements not found');
                    return;
                }
                
                let html = '<div class="space-y-2">';
                html += `<p><strong class="text-blue-900">Total Aktivitas:</strong> ${userContext.totalActivities}</p>`;
                
                if (userContext.stats) {
                    html += `<p><strong class="text-blue-900">Total Limbah:</strong> ${userContext.stats.totalWaste}</p>`;
                    html += `<p><strong class="text-blue-900">Nilai Ekonomi:</strong> ${userContext.stats.totalEconomicValue}</p>`;
                    html += `<p><strong class="text-blue-900">Rata-rata Eco-Score:</strong> ${userContext.stats.averageEcoScore}/10</p>`;
                }
                
                html += '<p class="text-xs text-gray-600 mt-2 pt-2 border-t border-blue-200">üí° AI sudah memiliki akses ke data aktivitas Anda. Tanya apapun tentang limbah Anda!</p>';
                html += '</div>';
                
                summaryContent.innerHTML = html;
                summaryCard.classList.remove('hidden');
                
                console.log('‚úÖ User data summary loaded');
            } else {
                console.log('‚ÑπÔ∏è No user data available yet');
            }
        } catch (error) {
            console.error('‚ùå Error loading user data summary:', error);
            // Don't show error to user, just log it
        }
    }
    
    // Function to toggle data summary visibility
    function toggleDataSummary() {
        const summaryCard = document.getElementById('user-data-summary');
        summaryCard.classList.toggle('hidden');
    }
    
    // Make functions globally accessible
    window.toggleDataSummary = toggleDataSummary;
    window.loadUserDataSummary = loadUserDataSummary;
    window.addMessageToChat = addMessageToChat;
    window.updateMessage = updateMessage;
    window.formatAIMessage = formatAIMessage;
    
    // Function to check and show latest activity notification
    async function checkLatestActivity() {
        try {
            const latestActivityStr = sessionStorage.getItem('latestActivity');
            
            if (latestActivityStr) {
                const activity = JSON.parse(latestActivityStr);
                const activityTime = new Date(activity.timestamp);
                const now = new Date();
                const diffMinutes = (now - activityTime) / (1000 * 60);
                
                // Tampilkan notifikasi jika aktivitas dalam 5 menit terakhir
                if (diffMinutes < 5) {
                    console.log('üì¢ Latest activity detected:', activity);
                    
                    // Mapping material names ke Indonesia
                    const materialNames = {
                        'plastic': 'plastik',
                        'paper': 'kertas',
                        'metal': 'logam',
                        'organic': 'organik',
                        'electricity': 'listrik',
                        'water': 'air'
                    };
                    
                    const actionNames = {
                        'recycled': 'didaur ulang',
                        'reduced': 'dikurangi',
                        'reused': 'digunakan ulang',
                        'disposed': 'dibuang',
                        'conserved': 'dihemat'
                    };
                    
                    const materialName = materialNames[activity.material] || activity.material;
                    const actionName = actionNames[activity.action] || activity.action;
                    
                    // Buat pesan AI otomatis
                    const aiMessage = `üéâ Saya lihat Anda baru saja menginput data **${materialName}** sebanyak **${activity.amount} ${activity.unit}** yang ${actionName}!

üìä **Detail Aktivitas:**
‚Ä¢ Material: ${materialName.charAt(0).toUpperCase() + materialName.slice(1)}
‚Ä¢ Jumlah: ${activity.amount} ${activity.unit}
‚Ä¢ Aksi: ${actionName.charAt(0).toUpperCase() + actionName.slice(1)}
‚Ä¢ Nilai Ekonomi: Rp ${activity.economicValue?.toLocaleString() || 0}
‚Ä¢ Eco-Score: ${activity.ecoScore}/10

üí° **Apa yang bisa saya bantu?**
‚Ä¢ Ingin analisis lebih detail tentang ${materialName} ini?
‚Ä¢ Butuh saran produk yang bisa dibuat?
‚Ä¢ Mau hitung potensi profit dari ${materialName} Anda?

Silakan tanya apapun tentang data yang baru saja Anda input! üòä`;

                    // Tampilkan pesan AI
                    setTimeout(() => {
                        addMessageToChat(aiMessage, 'assistant');
                    }, 1000);
                    
                    // Clear session storage setelah ditampilkan
                    sessionStorage.removeItem('latestActivity');
                }
            }
        } catch (error) {
            console.error('Error checking latest activity:', error);
        }
    }

    /**
     * Setup listener untuk AI Auto Notification
     * Mendengarkan event dari sistem auto-notification
     */
    function setupAIAutoNotificationListener() {
        console.log('üîî Setting up AI auto notification listener...');
        
        // Listen untuk custom event dari auto-notification service
        document.addEventListener('aiAutoNotification', async (event) => {
            console.log('üì¢ Received AI auto notification event:', event.detail);
            
            const { analysis, activityData, timestamp } = event.detail;
            
            // Tampilkan notifikasi visual di chat
            showAutoNotificationToast(activityData);
            
            // Tambahkan pesan AI ke chat setelah delay singkat
            setTimeout(() => {
                addMessageToChat(analysis, 'assistant');
            }, 2000);
        });
        
        // Check untuk notifikasi yang tersimpan saat page load
        checkStoredAutoNotifications();
    }

    /**
     * Tampilkan toast notification untuk auto-notification
     * @param {Object} activityData - Data aktivitas
     */
    function showAutoNotificationToast(activityData) {
        // Buat toast notification element
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg z-50 max-w-sm animate-slide-in';
        toast.innerHTML = `
            <div class="flex items-center space-x-3">
                <div class="text-2xl">ü§ñ</div>
                <div>
                    <div class="font-semibold">AI Menganalisis Aktivitas Anda!</div>
                    <div class="text-sm opacity-90">Material: ${activityData.material}</div>
                    <div class="text-sm opacity-90">Jumlah: ${activityData.jumlah}</div>
                </div>
            </div>
        `;
        
        // Tambahkan ke body
        document.body.appendChild(toast);
        
        // Auto remove setelah 5 detik
        setTimeout(() => {
            toast.classList.add('animate-slide-out');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 5000);
    }

    /**
     * Check untuk notifikasi auto yang tersimpan di sessionStorage
     */
    function checkStoredAutoNotifications() {
        try {
            const notifications = JSON.parse(sessionStorage.getItem('aiNotifications') || '[]');
            const unreadNotifications = notifications.filter(n => !n.isRead);
            
            if (unreadNotifications.length > 0) {
                console.log(`üì¨ Found ${unreadNotifications.length} unread AI notifications`);
                
                // Tampilkan notifikasi terbaru
                const latestNotification = unreadNotifications[0];
                
                // Tampilkan toast
                showAutoNotificationToast(latestNotification.activityData);
                
                // Tambahkan ke chat setelah delay
                setTimeout(() => {
                    addMessageToChat(latestNotification.message, 'assistant');
                    
                    // Mark as read
                    if (typeof aiAutoNotificationService !== 'undefined') {
                        aiAutoNotificationService.markNotificationAsRead(latestNotification.id);
                    }
                }, 2000);
            }
        } catch (error) {
            console.error('‚ùå Error checking stored notifications:', error);
        }
    }
    
    // Function to ensure proper chat container sizing
    function ensureChatContainerSizing() {
        const chatMessages = document.getElementById('chat-messages');
        if (chatMessages) {
            // Set proper height for chat container
            const viewportHeight = window.innerHeight;
            const headerHeight = 120; // Approximate header height
            const inputHeight = 100; // Approximate input area height
            const navHeight = 80; // Approximate bottom nav height
            
            const availableHeight = viewportHeight - headerHeight - inputHeight - navHeight;
            chatMessages.style.height = `${Math.max(availableHeight, 400)}px`;
            chatMessages.style.maxHeight = `${Math.max(availableHeight, 400)}px`;
            
            console.log('üìè Chat container sized:', {
                viewportHeight,
                availableHeight,
                chatHeight: chatMessages.style.height
            });
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ Initializing chat page...');
        
        // Ensure proper chat container sizing
        ensureChatContainerSizing();
        
        // Check for latest activity and show notification
        checkLatestActivity();
        
        // Setup AI Auto Notification listener
        setupAIAutoNotificationListener();
        
        // Setup chat listeners
        if (typeof setupChatListeners === 'function') {
            setupChatListeners();
        } else {
            console.log('‚ö†Ô∏è setupChatListeners not available, using manual setup');
        }
        
        // Wait a bit for scripts to load, then check handleChatInteraction
        setTimeout(() => {
            if (window.handleChatInteraction) {
                console.log('‚úÖ handleChatInteraction is available');
            } else {
                console.log('‚ö†Ô∏è handleChatInteraction not available, will use fallback');
                // Try to import it manually
                import('../../assets/js/chat/chat-logic.js').then(module => {
                    if (module.handleChatInteraction) {
                        window.handleChatInteraction = module.handleChatInteraction;
                        console.log('‚úÖ handleChatInteraction imported manually');
                    }
                }).catch(err => {
                    console.error('‚ùå Failed to import handleChatInteraction:', err);
                });
            }
        }, 1000);
        
        // Setup send button listener
        const sendBtn = document.getElementById('send-chat-btn');
        const chatInput = document.getElementById('chat-input');
        
        console.log('üîç Send button:', sendBtn);
        console.log('üîç Chat input:', chatInput);
        
        if (sendBtn) {
            console.log('‚úÖ Send button found, adding listener');
            
            // Add click listener
            sendBtn.addEventListener('click', async (e) => {
                console.log('üîÑ Send button clicked!');
                e.preventDefault();
                e.stopPropagation();
                
                const input = document.getElementById('chat-input');
                console.log('üîç Input value:', input?.value);
                
                if (input && input.value.trim()) {
                    console.log('üì§ Sending message:', input.value);
                    try {
                        await sendMessage();
                        console.log('‚úÖ Message sent successfully');
                    } catch (error) {
                        console.error('‚ùå Error in sendMessage:', error);
                    }
                } else {
                    console.log('‚ö†Ô∏è No message to send');
                    // Visual feedback
                    const originalText = sendBtn.innerHTML;
                    sendBtn.innerHTML = '‚ö†Ô∏è';
                    setTimeout(() => {
                        sendBtn.innerHTML = originalText;
                    }, 1000);
                }
            });
            
            console.log('‚úÖ Send button listener added');
        } else {
            console.error('‚ùå Send button not found!');
        }
        
        // Also add Enter key listener
        if (chatInput) {
            chatInput.addEventListener('keypress', async (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    console.log('‚å®Ô∏è Enter key pressed');
                    e.preventDefault();
                    if (chatInput.value.trim()) {
                        await sendMessage();
                    }
                }
            });
        }
        
        // Add window resize listener
        window.addEventListener('resize', () => {
            ensureChatContainerSizing();
        });
        
        console.log('‚úÖ Chat page initialized');
    });
    </script>
    <!-- Import chat logic and services -->
    <script type="module" src="../../assets/js/chat/chat-logic.js"></script>
    <script type="module" src="../../assets/js/core/gemini-service.js"></script>
    <script type="module" src="../../assets/js/core/local-storage-service.js"></script>
    <script type="module" src="../../assets/js/core/testing-account-service.js"></script>
    <!-- Di index.html dan profil.html -->
    <script type="module" src="../../assets/js/auth.js"></script>
    <script type="module" src="../../assets/js/core/user-stats.js"></script>
</body>
</html>