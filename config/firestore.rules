rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function untuk cek admin
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.email in [
               'admin@mi.com', 
               'admin@moralintelligence.com',
               'superadmin@mi.com',
               'nadyarara08@gmail.com'
             ];
    }

    // Users collection - WAJIB ADA untuk Google login
    match /users/{userId} {
      allow read: if request.auth != null && 
                     (request.auth.uid == userId || isAdmin());
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && 
                       (request.auth.uid == userId || isAdmin());
      allow delete: if isAdmin();
    }

    // User Stats
    match /userStats/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }
    
    // Quiz Results
    match /quizResults/{resultId} {
      allow read: if request.auth != null && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if request.auth != null &&
                      request.resource.data.userId == request.auth.uid;
    }
    
    // Survey Responses
    match /surveyResponses/{responseId} {
      allow read: if isAdmin();
      allow create: if request.auth != null &&
                      request.resource.data.userId == request.auth.uid;
    }
    
    // Forum Posts
    match /posts/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null &&
        (request.auth.uid == resource.data.authorId || isAdmin());
      
      // Gabungkan aturan update untuk likes/comments
      allow update: if request.auth != null &&
        (
          request.auth.uid == resource.data.authorId || 
          isAdmin() ||
          request.resource.data.likes is int || 
          request.resource.data.comments.size() >= resource.data.comments.size()
        );
    }
    
    // Materials
    match /materials/{document} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // Chat History
    match /chatHistory/{chatId} {
      allow create: if request.auth != null &&
                    request.resource.data.userId == request.auth.uid;
      allow read, delete: if request.auth != null &&
                          resource.data.userId == request.auth.uid;
    }
    
    // Quiz History
    match /quizHistory/{historyId} {
      allow create: if request.auth != null &&
                    request.resource.data.userId == request.auth.uid;
      allow read, delete: if request.auth != null &&
                          resource.data.userId == request.auth.uid;
    }

    // Admin collections
    match /admin/{document} {
      allow read, write: if isAdmin();
    }

    // System stats (untuk dashboard)
    match /systemStats/{document} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
  }
}
